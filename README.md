# SQL-improvement
T-SQL scripts for creating Blogging database with SP, VIEW, etc.

#### Task
0. Создать необходимую SQL схему для описания следующей модели данных:
Есть список пользователей с характеристиками: логин, пароль, имя, email. Email и логин каждого пользователя - уникальные поля. Каждый пользователь может создать блог и наполнить блог статьями. Блог имеет свое название и дату создания, а так же флаг оплатил ли пользователь блог или нет. В бесплатном блоге может быть не более 100 статей, а в целом у пользователям может быть не более 1000 статей по всем неоплаченным блогам. Если пользователь добавляет больше статей, чем разрешено для бесплатного блога, то эти статьи должны помечаться как заблокированные, пока пользователь не оплатит блог. Если блог оплачен, то ограничения не действуют и заблокированные статьи переводятся в статус обычных. Каждый пользователь может оставить комментарий к любой статье. Так же пользователь может выставить рейтинг для любой статьи.
Создать необходимый набор sql view, stored procedure, function для выполнения следующих задач:
  * Создание пользователя;
  * Создание блога;
  * Оплата блога;
  * Добавление статьи к блогу;
  * Добавление рейтинга к статье. рейтинг может быть выставлен от 1 до 5, причем один и тот же пользователь может сделать это только 1 раз. Выставить значения меньше 1 и больше 5 нельзя. При повторном выставлении рейтинга должен обновляться сущесвующий, либо добавляться новый если пользователь еще не оставлял рейтинг для статьи. При выставлении рейтинг должен пересчитываться средний рейтинг для статьи, на основе оставленных рейтингов всеми пользователями;
  * Поиск статей, дата создания которых больше переданной даты. Вывести инфморацию о блоге, пользователе и количестве комментариев для каждой найденной статьи;
  * Вывести список пользователей и средний рейтинг по ВСЕМ его статьям. Если у статьи нет рейтинга, то не использовать ее в подсчете среднего по всем статьям;
  * Выбрать все неоплаченные блоги и данные о создателях этих блогов. Должно быть включено количество заблокированных статей в блоге, открытых для просмотра, и общее количество статей в блоге и средний рейтинг блога как средний рейтинг по всем статьям этого блога. Если у статьи нет рейтинга, то не использовать ее в подсчете среднего по всем статьям.

0. Все упомянутые ограничения по возможности реализовать на уровне таблиц, а не хранимых процедур;
0. Операции UPDATE/DELETE/INSERT должны быть обернуты в транзакции, при чем использовать применить как можно больше уровней изоляции;
0. По возможности операции выборки данных из нескольких таблиц должны представлять собой sql view;
0. Проанализировать Execution Plan каждого запроса. Выполнить необходимые действия для оптимизации плана выполнения. Показать скриншот плана выполнения до оптимизации запроса и после.

#### Views
* UnpaidBlogs
* UsersInfo
* BlogRating (using in UnpaidBlogs view)
* ArticlesComments (using in FindArticles SP)
* ArticlesInfo (using in FindArticles SP)

#### SP signatures
* CreateUser
  * Login varchar(30),
  * Password varchar(30),
  * Name varchar(20),
  * Email varchar(60)
  
* CreateBlog
  * UserId int,
  * Name varchar(60) //Blog name
  
* CreateArticle
  * BlogId int,
  * Title varchar(60),
  * Content varchar(max)

* FindArticles
  * Date datetime
  
* PayBlog
  * BlogId int
  
* Vote
  * UserId int,
  * ArticleId int,
  * Value int
